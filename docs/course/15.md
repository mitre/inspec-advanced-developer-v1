---
prev: ./14
next: ./16
---


## 15. Exercise: Process for pushing your resource up to InSpec

### 15.1. Preparing the repo
First thing we will need to do is go to the inspec github repo [InSpec Github Repo](https://github.com/inspec/inspec) and click the fork button on the repo

![Alt text](/Fork_Repo.png)

Next we will need to clone that forked repo. Make sure when you are cloning you are pulling from your repo and not the upstream inspec repo.

![Alt text](/Clone_Repo.png)

Take the url from the image above and in your terminal type the git clone along with the url for your forked repo

```bash
git clone urlHere
```

#### 15.1.1. (Optional) Configure a remote upstream
When contributing to a repo from a fork you will be updating your fork from time to time to be updated with the master repo. As such you would be required to have a git remote for the upstream branch, the command to do this is as follows:

If using https:
```bash
git remote add upstream https://github.com/inspec/inspec.git
```

If using ssh:
```bash
git remote add upstream git@github.com:inspec/inspec.git
```

### 15.2. Working on our Resource: docker_compose_config
Now that we have the repo cloned the inspec repo, we will work through our docker_compose_config file as an example to pushing up the repo.

#### 15.2.1. Making a branch
The first step is we will create a new branch named similarly to our resource.

```bash
git checkout -b docker_compose_config_resource
```

Next we need to push up our new branch and add tracking to that branch to our repo.

```bash
git push -u origin docker_compose_config_resource
```

#### 15.2.2. Placing the resource
Under the `lib/inspec/resources/` directory we will create a new file called `docker_compose_config.rb`

Once that is created we will slightly modify our resource file as shown: 

```ruby
# encoding: utf-8
# copyright: 2019, The Authors

module Inspec::Resources
  class DockerComposeConfig < Inspec.resource(1)

      name 'docker_compose_config'

      supports platform: "unix"
      supports platform: "windows"

      desc '
          Use the docker_compose_config resource to parse through docker-compose configuration files
      '

      example <<~EXAMPLE
          describe docker_compose_config('file_name') do
              its('services.workstation.image') { should eq 'learnchef/inspec_workstation' }
              its('services.workstation.volumes') { should cmp '.:/root' }
          end
      EXAMPLE
  
      def initialize(path)
      @path = path
      @yaml = inspec.yaml(path)
      end
  
      def services
      Hashie::Mash.new @yaml['services']
      end
  
  end
end
```

The key difference here is that we are adding the module to the top of the file as well as adding the supports, desc and example.  

Next we need to add the `docker_compose_config` to the `resources.rb` located at `lib/inspec/resources.rb` helper file. The helper file is in alphabetical order so place your resource in the file alphabetically as such:

```ruby
require "inspec/resources/docker"
require "inspec/resources/docker_compose_config" # This is the line being added to the file
require "inspec/resources/docker_container"
```

#### 15.2.3. Creating the Docs
Now we want to create the docs explaining how to use our resource, we will create a file called `docker_compose_config.md.erb` at the `docs/resources/` location.

```ruby
---
title: About the docker_compose_config Resource
platform: os
---

# docker_compose_config

Use the `docker_compose_config` Chef InSpec audit resource to test configurations that are defined in `docker-compose.yml` files.

<br>

## Availability

### Installation

This resource is distributed along with Chef InSpec itself. You can use it automatically.

### Version

This resource first became available in v4.6.9 of InSpec.

## Syntax

A `docker_compose_config` resource block declares tests for configurations in docker-compose.yml files:

    describe docker_compose_config('filename.yml') do
      its('name') { should eq 'foo' }
      its('services.name') { should eq 'one' }
    end

where

* `name` is a configuration setting in a Yaml file
* `should eq 'foo'` tests a value of `name` as read from a Yaml file versus the value declared in the test

<br>

## Examples

The following examples show how to use this Chef InSpec audit resource.

### Test a docker-compose.yml file

    describe docker_compose_config('file_name') do
      its('services.workstation.image') { should eq 'learnchef/inspec_workstation' }
      its('services.workstation.volumes') { should cmp '.:/root' }
    end

<br>

## Matchers

For a full list of available matchers, please visit our [matchers page](https://www.inspec.io/docs/reference/matchers/).

### name

The `name` matcher tests the value of `name` as read from a docker-compose.yml file versus the value declared in the test:

    its('name') { should eq 'foo' }
```

In it's simplest form the above is how you would form your documenation file.  

#### 15.2.4. Setting up the testing
To perform tests on an inspec resource that you create first you will need to set up the testing platform for it. In InSpec we use chef cookbooks to handle the setup for us, we just have to configure it as follows.

First create a new file at `test/cookbooks/os_prepare/recipes/` called `docker_compose_config.rb` and it's content's will look like this:

```ruby
#
# prepares a sample file for verification

if node["platform_family"] != "windows"
    file "/tmp/docker-compose.yml" do
      mode "0765"
      content "
      version: '3'
      services:
        workstation:
          container_name: workstation
          image: learnchef/inspec_workstation
          stdin_open: true
          tty: true
          links:
            - target
          volumes:
            - .:/root
        target:
          image: learnchef/inspec_target
          stdin_open: true
          tty: true
          "
    end
  
  else
  
    file 'C:\Test Directory\docker-compose.yml' do
      content "
      version: '3'
      services:
        workstation:
          container_name: workstation
          image: learnchef/inspec_workstation
          stdin_open: true
          tty: true
          links:
            - target
          volumes:
            - .:/root
        target:
          image: learnchef/inspec_target
          stdin_open: true
          tty: true
          "
    end
  
end
```

We also must change the helper file to include our newly created configuration above. We change the helper file at `test/cookbooks/os_prepare/recipes/default.rb` like so:

```ruby
#
# prepare all operating systems with the required configuration

apt_update if platform_family?("debian")

# inject the current inspec gem for use with audit cookbook
# this is generated via Rake test:integration
cookbook_file "/root/inspec-core-local.gem" do
  source "inspec-core-local.gem"
  action :create
end

chef_gem "inspec" do
  source "/root/inspec-core-local.gem"
end

def uuid_from_string(string)
  require "digest/sha1"
  hash = Digest::SHA1.new
  hash.update(string)
  ary = hash.digest.unpack("NnnnnN")
  ary[2] = (ary[2] & 0x0FFF) | (5 << 12)
  ary[3] = (ary[3] & 0x3FFF) | 0x8000
  "%08x-%04x-%04x-%04x-%04x%08x" % ary
end

# set a static node uuid for our testing nodes
Chef::Config[:chef_guid] = uuid_from_string(node.name)

# confgure ssh
include_recipe("os_prepare::ssh")

# basic tests
include_recipe("os_prepare::file")
include_recipe("os_prepare::mount") unless node["osprepare"]["docker"]
include_recipe("os_prepare::service")
include_recipe("os_prepare::package")
include_recipe("os_prepare::registry_key")
include_recipe("os_prepare::iis")
include_recipe("os_prepare::iptables")
include_recipe("os_prepare::x509")
include_recipe("os_prepare::dh_params")

# config file parsing
include_recipe("os_prepare::json_yaml_csv_ini_xml")
include_recipe("os_prepare::docker_compose_config") # this is the line we are adding

# configure repos, eg. nginx
include_recipe("os_prepare::apt")

# application configuration
if node["osprepare"]["application"] && node["platform_family"] != "windows"
  include_recipe("os_prepare::postgres")
  include_recipe("os_prepare::auditctl") unless node["osprepare"]["docker"]
  include_recipe("os_prepare::apache")
end

# docker host testing
include_recipe("os_prepare::docker_host") unless node["osprepare"]["docker"]

include_recipe("os_prepare::os_env")
```

#### 15.2.5. Creating the actual tests
