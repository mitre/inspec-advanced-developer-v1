---
prev: ./2
next: ./4
---

## 3. Recap of an InSpec profile
Let's start by creating a profile that will contain NGINX tests.

Start by moving to the /root directory.

```bash
$ cd ~
```

Next, create an InSpec profile named my_nginx.

```bash
inspec init profile my_nginx
```

The terminal output should look like the following:

```bash
$ inspec init profile my_nginx
Create new profile at /root/my_nginx
 * Create directory controls
 * Create file controls/example.rb
 * Create file inspec.yml
 * Create directory libraries
 * Create file README.md
```



### 3.1. Understanding the profile structure

Let's take a look at how the profile is structured. We'll start with how a profile's files are structured and then move to what makes up an InSpec control.

First, run `tree` to see what's in the `my_nginx` profile.

```bash
$ tree my_nginx
      my_nginx
      ├── README.md
      ├── controls
      │   └── example.rb
      ├── inspec.yml
      └── libraries

      2 directories, 3 files
```

Here's the role of each component.

* `README.md` provides documentation about the profile, including what it covers and how to run it.
* The `controls` directory contains files which implement the InSpec tests.
* `inspec.yml` provides metadata, or information, about the profile. Metadata includes the profile's description, author, copyright, and version.
* The `libraries` directory contains resource extensions. A resource extension enables you to [define your own resource types](https://www.inspec.io/docs/reference/dsl_resource/). You won't work with resource extensions in this module.



### 3.2. Understand a control's structure

Let's take a look at the default control file, `controls/example.rb`.

```ruby
title 'sample section'

# you can also use plain tests
describe file('/tmp') do
  it { should be_directory }
end

# you add controls here
control 'tmp-1.0' do                        # A unique ID for this control
  impact 0.7                                # The criticality, if this control fails.
  title 'Create /tmp directory'             # A human-readable title
  desc 'An optional description...'
  describe file('/tmp') do                  # The actual test
    it { should be_directory }
  end
end
```
::: tip Tip for developing profiles
When creating new profiles use the existing example file as a template
:::

This example shows two tests. Both tests check for the existence of the `/tmp` directory. The second test provides additional information about the test. Let's break down each component.

* `control` (line 12) is followed by the control's name. Each control in a profile has a unique name.
* `impact` (line 13) measures the relative importance of the test and must be a value between 0.0 and 1.0.
* `title` (line 14) defines the control's purpose.
* `desc` (line 15) provides a more complete description of what the control checks for.
* `describe` (lines 16 — 18) defines the test. Here, the test checks for the existence of the `/tmp` directory.

In Ruby, the `do` and `end` keywords define a `block`. An InSpec control always contains at least one `describe` block. However, a control can contain many `describe` blocks.
::: tip More information on a block
[block](http://ruby-for-beginners.rubymonstas.org/blocks.html)
:::


### 3.3. Understand a describe block's structure

As with many test frameworks, InSpec code resembles natural language. Here's the format of a describe block.

```ruby
describe <entity> do
  it { <expectation> }
end
```

An InSpec test has two main components: the subject to examine and the subject's expected state. Here, `<entity>` is the subject you want to examine, for example, a package name, service, file, or network port. The `<expectation>` part specifies the desired result or expected state, for example, that a port should be open (or perhaps should not be open.)

Let's take a closer look at the `describe` block in the example.

```ruby
describe file('/tmp') do
  it { should be_directory }
end
```

Because InSpec resembles human-readable language, you might read this test as "/tmp should be a directory." Let's break down each component.

---
#### 3.3.1. file

[file](https://www.inspec.io/docs/reference/resources/file/) is an InSpec [resource](https://www.inspec.io/docs/reference/resources/). If you're familiar with Chef, you know that a resource configures one part of the system. InSpec resources are similar. For example, the InSpec file resource tests for file attributes, including a file's owner, mode, and permissions. The example examines the /tmp directory.

---
#### 3.3.2. it

The `it` statement validates one of your resource's features. A `describe` block contains one or more `it` statements. `it` enables you to test the resource itself. You'll also see `its`, which describes some feature of the resource, such as its mode or owner. You'll see examples of both `it` and `its` shortly.

---
#### 3.3.3. should

`should` describes the expectation. `should` asserts that the condition that follows _should_ be true. Alternatively, `should_not` asserts that the condition that follows _should not_ be true. You'll see examples of both shortly.

---
#### 3.3.4. be_directory

`be_directory` is an example of a [matcher](https://www.inspec.io/docs/reference/matchers/). A matcher compares a resource's actual value to its expected value. InSpec provides several predefined matchers. The `file` resource provides the `be_directory` matcher.

### 3.4. Profile Inheritance/Overlays

In addition to its own controls, an InSpec profile can bring in the controls from another InSpec profile. Additionally, when inheriting the controls of another profile, a profile can skip or even modify those included controls.

When a profile includes controls from another profile, it is usually referred to as a “meta profile” or a “profile overlay.” Those of us with Chef background sometimes call it a “wrapper profile”.

#### 3.4.1. Defining the dependency
Before a profile can use controls from another profile, the to-be-included profile needs to be specified in the including profile’s inspec.yml file in the depends section. For each profile to be included, a location for the profile from where to be fetched and a name for the profile should be included. For example:

```yaml
depends:
 - name: linux-baseline
   url: https://github.com/dev-sec/linux-baseline/archive/master.tar.gz
 - name: ssh-baseline
   url: https://github.com/dev-sec/ssh-baseline/archive/master.tar.gz
```

Once defined in the inspec.yml, controls from the included profiles can be used!

#### 3.4.2. Including All Controls from a Profile
With the include_controls command in a profile, all controls from the named profile will be executed every time the including profile is executed.

`my_nginx` profile
```ruby
control 'nginx-version' do
  impact 1.0
  title 'NGINX version'
  desc 'The required version of NGINX should be installed.'
end

control 'nginx-modules' do
  impact 1.0
  title 'NGINX modules'
  desc 'The required NGINX modules should be installed.'
end

control 'nginx-conf' do
  impact 1.0
  title 'NGINX configuration'
  desc 'The NGINX config file should owned by root, be writable only by owner, and not writeable or and readable by others.'
end

include_controls `my-nginx-overlay`
```

`my-nginx-overlay`
```ruby
control `first-overlay-control`
control `second-overlay-control`
```

In the example above, every time `my-nginx` profile is executed, all the controls from `my-nginx-overlay` are also executed. Therefore, the following controls would be executed:

 - nginx-version
 - nginx-modules
 - nginx-conf
 - first-overlay-control
 - second-overlay-control

#### 3.4.3. Skipping a control from profile
What if one of the controls from the included profile does not apply to your environment? Luckily, it is not necessary to maintain a slightly-modified copy of the included profile just to delete a control. The skip_control command tells InSpec to not run a particular control.

`my_nginx` profile
```ruby
control 'nginx-version' do
  impact 1.0
  title 'NGINX version'
  desc 'The required version of NGINX should be installed.'
end

control 'nginx-modules' do
  impact 1.0
  title 'NGINX modules'
  desc 'The required NGINX modules should be installed.'
end

control 'nginx-conf' do
  impact 1.0
  title 'NGINX configuration'
  desc 'The NGINX config file should owned by root, be writable only by owner, and not writeable or and readable by others.'
end

include_controls `my-nginx-overlay` do
  skip_control `second-overlay-control`
end
```

`my-nginx-overlay`
```ruby
control `first-overlay-control`
control `second-overlay-control`
```
In the above example, all controls from `my-nginx` profile and `my-nginx-overlay` profile will be executed every time my-app-profile is executed **except** for control `second-overlay-control` from the `my-nginx-overlay` profile.

#### 3.4.4. Modifying a Control
Let’s say a particular control from an included profile should still be run, but the impact isn’t appropriate? Perhaps the test should still run, but if it fails it should be treated as low severity instead of high severity?

When a control is included, it can also be modified!

`my_nginx` profile
```ruby
control 'nginx-version' do
  impact 1.0
  title 'NGINX version'
  desc 'The required version of NGINX should be installed.'
end

control 'nginx-modules' do
  impact 1.0
  title 'NGINX modules'
  desc 'The required NGINX modules should be installed.'
end

control 'nginx-conf' do
  impact 1.0
  title 'NGINX configuration'
  desc 'The NGINX config file should owned by root, be writable only by owner, and not writeable or and readable by others.'
end

include_controls `my-nginx-overlay` do
  control `second-overlay-control` do
    impact 0.5
  end
end
```

`my-nginx-overlay`
```ruby
control `first-overlay-control` do
  impact 1.0
end
control `second-overlay-control`
```
In the above example, all controls from `my-nginx` profile are executed along with all the controls from the including profile, `my-nginx-overlay`. However, should control `first-overlay-control` fail, it will be raised with an impact of `0.5` instead of the originally-intended impact of `1.0`.

#### 3.4.5. Selectively Including Controls from a Profile
If there are only a handful of controls that should be executed from an included profile, it’s not necessary to skip all the unneeded controls, or worse, copy/paste those controls bit-for-bit into your profile. Instead, use the require_controls command.

`my_nginx` profile
```ruby
control 'nginx-version' do
  impact 1.0
  title 'NGINX version'
  desc 'The required version of NGINX should be installed.'
end

control 'nginx-modules' do
  impact 1.0
  title 'NGINX modules'
  desc 'The required NGINX modules should be installed.'
end

control 'nginx-conf' do
  impact 1.0
  title 'NGINX configuration'
  desc 'The NGINX config file should owned by root, be writable only by owner, and not writeable or and readable by others.'
end

require_controls `my-nginx-overlay` do
  control `first-overlay-control`
  control `third-overlay-control`
end
```

`my-nginx-overlay`
```ruby
control `first-overlay-control`
control `second-overlay-control`
control `third-overlay-control`
control `fourth-overlay-control`
control `fifth-overlay-control`
```

Whenever `my_nginx` is executed, in addition to its own controls, it will run only the controls specified in the require_controls block. In the case, the following controls would be executed:

 - nginx-version
 - nginx-modules
 - nginx-conf
 - first-overlay-control
 - third-overlay-control

Controls `second-overlay-control`, `fourth-overlay-control`, and `fifth-overlay-control` would not be run, just as if they were manually skipped. This method of including specific controls ensures only the controls specified are executed; if new controls are added to a later version of `my-nginx-overlay`, they would not be run.

And, just the way its possible to modify controls when using include_controls, controls can be modified as well.

`my_nginx` profile
```ruby
control 'nginx-version' do
  impact 1.0
  title 'NGINX version'
  desc 'The required version of NGINX should be installed.'
end

control 'nginx-modules' do
  impact 1.0
  title 'NGINX modules'
  desc 'The required NGINX modules should be installed.'
end

control 'nginx-conf' do
  impact 1.0
  title 'NGINX configuration'
  desc 'The NGINX config file should owned by root, be writable only by owner, and not writeable or and readable by others.'
end

require_controls `my-nginx-overlay` do
  control `first-overlay-control` do
    impact 0.5
  end
  control `third-overlay-control`
end
```

`my-nginx-overlay`
```ruby
control `first-overlay-control` do
  impact 1.0
end
control `second-overlay-control`
control `third-overlay-control`
control `fourth-overlay-control`
control `fifth-overlay-control`
```

As with the prior example, only `first-overlay-control` and `third-overlay-control` are executed, but if `first-overlay-control` fails, it will report with an impact of `0.5` instead of the originally-intended `1.0` impact.

